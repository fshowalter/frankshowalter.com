## 2026-02-19 - Stage 1: Create `<search-box>` Element and Move Markup

- Created `src/astro/search-box.ts` — minimal `SearchBox extends HTMLElement` that calls `initPageFind()` in `connectedCallback()`. Registered with `customElements.define("search-box", SearchBox)`.
- Removed the auto-initialization block from the bottom of `search-modal.ts` (the `DOMContentLoaded` / `initSearch()` call) to prevent double-initialization when `search-box.ts` imports `search-modal.ts`.
- Wrapped the `<dialog>` element in `<search-box>...</search-box>` in `AstroPageShell.astro`. The open button stays in `Backdrop.tsx` for now (moved in a later stage).
- Updated `AstroPageShell.astro` script tag: `search-modal.ts` → `search-box.ts`.
- Deleted outdated HTML snapshots and re-ran `npm test` to regenerate them — all 29 tests pass, 2 snapshots written.

**Files changed:**
- `src/astro/search-box.ts` — created
- `src/astro/search-modal.ts` — removed auto-init block at bottom
- `src/astro/AstroPageShell.astro` — added `<search-box>` wrapper, updated script src
- `src/pages/__snapshots__/index.html` — regenerated
- `src/pages/404/__snapshots__/index.html` — regenerated

**Learnings for future iterations:**
- `toMatchFileSnapshot` in vitest creates the snapshot file on first run (when the file doesn't exist) rather than failing. This means deleting the snapshot file and running `npm test` is equivalent to `npm run test:update` for page snapshot tests.
- The search open button is in `Backdrop.tsx` (`SearchButton` sub-component) at `src/components/layout/Backdrop.tsx`. In the final architecture (Stage 3), this button needs to move inside `<search-box>` in `AstroPageShell.astro`.
- `search-modal.ts` had a module-level auto-init block guarded by `!process.env.VITEST`. When moving to a web component pattern, this must be removed so `connectedCallback()` is the single initialization point.
- Tests in `AstroPageShell.spec.ts` manually import and call `initPageFind()` from `search-modal.ts` directly — they don't go through the custom element. This is fine for Stage 1; Stage 2 will update the test strategy to test via the element.

---

## 2026-02-19 - Stage 3: Merge SearchUI into Component and Add Templates

- Rewrote `src/astro/search-box.ts` — absorbed all `SearchUI` logic directly into `SearchBox`. Added `SearchState` type and `formatCounter()` (moved from `search-ui.ts`). `PagefindAPI` is now a static import and instantiated as an instance field. `setupEventListeners()` is called synchronously in `connectedCallback()` (no longer deferred to after API init), so Enter-key and clear-button event tests work without API initialization. `PagefindAPI.init()` is still called lazily on first modal open.
- Added `<template>` elements to `AstroPageShell.astro` inside `<search-box>`: `data-result-item`, `data-skeleton`, `data-empty`, `data-error`. All dynamic content now rendered via `template.content.cloneNode(true)` — no HTML strings in JS.
- Renamed element IDs in `AstroPageShell.astro` from `search-*` to `search-box-*` prefix. Updated `aria-describedby` and `aria-controls` to match.
- Replaced `resolveSearchElements()` with direct `this.querySelector()` calls using the new `search-box-*` IDs.
- Deleted `src/astro/search-ui.ts` and `src/astro/search-ui.spec.ts`.
- Updated `AstroPageShell.spec.ts`: removed `SearchElements` import from `search-ui`; changed mock from `vi.mock("./search-ui")` to `vi.mock("./pagefind-api")` injecting `mockSearchAPI` via `PagefindAPI: vi.fn().mockImplementation(() => mockSearchAPI)`; updated all `#search-*` selectors to `#search-box-*`.
- Created `src/astro/search-box.spec.ts` with `formatCounter` unit tests. Used `beforeAll` + dynamic import pattern to set `globalThis.HTMLElement` before importing `search-box.ts` (Node environment requires this).
- Regenerated HTML snapshots — all 29 tests pass, 2 snapshots updated.

**Files changed:**
- `src/astro/search-box.ts` — rewritten: SearchUI absorbed, templates, no HTML strings
- `src/astro/AstroPageShell.astro` — renamed IDs, added `<template>` elements, lint fixes applied
- `src/astro/AstroPageShell.spec.ts` — updated mock and ID selectors
- `src/astro/search-box.spec.ts` — created
- `src/astro/search-ui.ts` — deleted
- `src/astro/search-ui.spec.ts` — deleted
- `src/pages/__snapshots__/index.html` — regenerated
- `src/pages/404/__snapshots__/index.html` — regenerated

**Learnings for future iterations:**
- `vi.mock()` inside `beforeEach` works after `vi.resetModules()` for static imports in the target module — the factory is registered before the subsequent `await import()` call, so the mock is applied when the module is loaded.
- When moving from a dynamic import (lazy-loading `search-ui.ts` in `openModal()`) to a static import (`pagefind-api.ts` at the top of `search-box.ts`), the mock must now be set up before `initSearchBox()` is called (not before the open-button click). The `vi.resetModules()` + `vi.mock()` + `await initSearchBox()` sequence in `beforeEach` handles this correctly.
- `setupEventListeners()` called in `connectedCallback()` (synchronously) means the Enter-key and clear-button tests in the "search modal" describe block no longer need the API to be initialized — they work immediately after `connectedCallback()`.
- `<template>` elements in Astro SSR output are correctly parsed by JSDOM with their content in `template.content`. `template.content.cloneNode(true)` works as expected.
- The lint rule `better-tailwindcss/enforce-canonical-classes` flags `text-sm leading-normal` → `text-sm/normal` and `px-4 py-4` → `p-4` in template elements. Always run `npm run lint:fix` after adding template HTML in `.astro` files. After lint fix, regenerate snapshots again.

---

## 2026-02-19 - Stage 2: Move Modal Logic into the Component

- Rewrote `src/astro/search-box.ts` — moved all modal logic from `search-modal.ts` into `SearchBox.connectedCallback()`. Open button still uses `document.querySelector("button[data-open-search]")` (it's in `Backdrop.tsx` outside `<search-box>`); all other elements use `this.querySelector()`. Instance state (`pagefindLoading`, `searchUIInstance`) replaces module-level state. Added `disconnectedCallback()` to remove the global Cmd+K keydown handler. Added `customElements.get` guard to prevent double-registration.
- Deleted `src/astro/search-modal.ts`.
- Changed `data-open-modal` → `data-open-search` in `Backdrop.tsx`.
- Changed `data-close-modal` → `data-close-search` in `AstroPageShell.astro`.
- Updated `AstroPageShell.spec.ts`: replaced `initPageFind()` import pattern with `initSearchBox()` helper that imports `search-box.ts` and calls `connectedCallback()` directly. Added `globalThis.HTMLElement = window.HTMLElement` and `globalThis.customElements = window.customElements` to both `beforeEach` blocks. Updated all `data-open-modal`/`data-close-modal` selectors. Mac keyboard shortcut test now calls `connectedCallback()` directly instead of re-importing the module.
- Deleted and regenerated HTML snapshots — all 29 tests pass.

**Files changed:**
- `src/astro/search-box.ts` — rewritten with full modal logic
- `src/astro/search-modal.ts` — deleted
- `src/components/layout/Backdrop.tsx` — `data-open-modal` → `data-open-search`
- `src/astro/AstroPageShell.astro` — `data-close-modal` → `data-close-search`
- `src/astro/AstroPageShell.spec.ts` — updated test strategy
- `src/pages/__snapshots__/index.html` — regenerated
- `src/pages/404/__snapshots__/index.html` — regenerated

**Learnings for future iterations:**
- `class SearchBox extends HTMLElement` in the module means `HTMLElement` must be globally available when the module is imported. Tests must set `globalThis.HTMLElement = window.HTMLElement` before calling `await import("./search-box.ts")`.
- `customElements.define()` must also use the JSDOM registry: set `globalThis.customElements = window.customElements` before importing. Each test creates a fresh JSDOM window so the registry is always empty at import time — no double-registration conflicts between tests.
- The `customElements.get("search-box")` guard in `search-box.ts` prevents `NotSupportedError` if the module is re-imported within the same JSDOM instance (e.g., Mac keyboard shortcut test re-calling `connectedCallback()`).
- Calling `connectedCallback()` manually after import is the most reliable way to initialize the element in JSDOM — JSDOM may not retroactively upgrade already-connected elements when `customElements.define()` is called.
- The Mac keyboard shortcut test no longer needs `vi.resetModules()` — it just calls `connectedCallback()` again after changing `navigator.userAgent`, which sets the attributes at the start of the callback.

---
