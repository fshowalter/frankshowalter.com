## 2026-02-19 - Stage 1: Create `<search-box>` Element and Move Markup

- Created `src/astro/search-box.ts` — minimal `SearchBox extends HTMLElement` that calls `initPageFind()` in `connectedCallback()`. Registered with `customElements.define("search-box", SearchBox)`.
- Removed the auto-initialization block from the bottom of `search-modal.ts` (the `DOMContentLoaded` / `initSearch()` call) to prevent double-initialization when `search-box.ts` imports `search-modal.ts`.
- Wrapped the `<dialog>` element in `<search-box>...</search-box>` in `AstroPageShell.astro`. The open button stays in `Backdrop.tsx` for now (moved in a later stage).
- Updated `AstroPageShell.astro` script tag: `search-modal.ts` → `search-box.ts`.
- Deleted outdated HTML snapshots and re-ran `npm test` to regenerate them — all 29 tests pass, 2 snapshots written.

**Files changed:**
- `src/astro/search-box.ts` — created
- `src/astro/search-modal.ts` — removed auto-init block at bottom
- `src/astro/AstroPageShell.astro` — added `<search-box>` wrapper, updated script src
- `src/pages/__snapshots__/index.html` — regenerated
- `src/pages/404/__snapshots__/index.html` — regenerated

**Learnings for future iterations:**
- `toMatchFileSnapshot` in vitest creates the snapshot file on first run (when the file doesn't exist) rather than failing. This means deleting the snapshot file and running `npm test` is equivalent to `npm run test:update` for page snapshot tests.
- The search open button is in `Backdrop.tsx` (`SearchButton` sub-component) at `src/components/layout/Backdrop.tsx`. In the final architecture (Stage 3), this button needs to move inside `<search-box>` in `AstroPageShell.astro`.
- `search-modal.ts` had a module-level auto-init block guarded by `!process.env.VITEST`. When moving to a web component pattern, this must be removed so `connectedCallback()` is the single initialization point.
- Tests in `AstroPageShell.spec.ts` manually import and call `initPageFind()` from `search-modal.ts` directly — they don't go through the custom element. This is fine for Stage 1; Stage 2 will update the test strategy to test via the element.

---

## 2026-02-19 - Stage 2: Move Modal Logic into the Component

- Rewrote `src/astro/search-box.ts` — moved all modal logic from `search-modal.ts` into `SearchBox.connectedCallback()`. Open button still uses `document.querySelector("button[data-open-search]")` (it's in `Backdrop.tsx` outside `<search-box>`); all other elements use `this.querySelector()`. Instance state (`pagefindLoading`, `searchUIInstance`) replaces module-level state. Added `disconnectedCallback()` to remove the global Cmd+K keydown handler. Added `customElements.get` guard to prevent double-registration.
- Deleted `src/astro/search-modal.ts`.
- Changed `data-open-modal` → `data-open-search` in `Backdrop.tsx`.
- Changed `data-close-modal` → `data-close-search` in `AstroPageShell.astro`.
- Updated `AstroPageShell.spec.ts`: replaced `initPageFind()` import pattern with `initSearchBox()` helper that imports `search-box.ts` and calls `connectedCallback()` directly. Added `globalThis.HTMLElement = window.HTMLElement` and `globalThis.customElements = window.customElements` to both `beforeEach` blocks. Updated all `data-open-modal`/`data-close-modal` selectors. Mac keyboard shortcut test now calls `connectedCallback()` directly instead of re-importing the module.
- Deleted and regenerated HTML snapshots — all 29 tests pass.

**Files changed:**
- `src/astro/search-box.ts` — rewritten with full modal logic
- `src/astro/search-modal.ts` — deleted
- `src/components/layout/Backdrop.tsx` — `data-open-modal` → `data-open-search`
- `src/astro/AstroPageShell.astro` — `data-close-modal` → `data-close-search`
- `src/astro/AstroPageShell.spec.ts` — updated test strategy
- `src/pages/__snapshots__/index.html` — regenerated
- `src/pages/404/__snapshots__/index.html` — regenerated

**Learnings for future iterations:**
- `class SearchBox extends HTMLElement` in the module means `HTMLElement` must be globally available when the module is imported. Tests must set `globalThis.HTMLElement = window.HTMLElement` before calling `await import("./search-box.ts")`.
- `customElements.define()` must also use the JSDOM registry: set `globalThis.customElements = window.customElements` before importing. Each test creates a fresh JSDOM window so the registry is always empty at import time — no double-registration conflicts between tests.
- The `customElements.get("search-box")` guard in `search-box.ts` prevents `NotSupportedError` if the module is re-imported within the same JSDOM instance (e.g., Mac keyboard shortcut test re-calling `connectedCallback()`).
- Calling `connectedCallback()` manually after import is the most reliable way to initialize the element in JSDOM — JSDOM may not retroactively upgrade already-connected elements when `customElements.define()` is called.
- The Mac keyboard shortcut test no longer needs `vi.resetModules()` — it just calls `connectedCallback()` again after changing `navigator.userAgent`, which sets the attributes at the start of the callback.

---
