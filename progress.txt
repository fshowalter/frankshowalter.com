## 2026-02-19 - Stage 1: Add singular "1 result" integration test

- Added counter assertion to "clears results when user clears the input" test in `AstroPageShell.spec.ts`
- The test already mocked exactly 1 result; only the counter assertion was missing
- Counter now asserts `'1 result for "test"'` after results render, before the clear step
- This covers the `formatCounter` singular branch via integration (prerequisite for Stage 2)

**Files changed**:
- `src/astro/AstroPageShell.spec.ts` — added 2 lines inside `waitFor` block

**Pre-existing failure** (unrelated to Stage 1):
- "sets Mac keyboard shortcut" test was already failing before this change — `aria-keyshortcuts` shows `Control+K` instead of `Meta+K`; likely a JSDOM user-agent detection issue

**Missing permissions**: None

**Learnings for future iterations:**
- The `waitFor` block already existed and waited for result render — the counter assertion fits naturally inside it (avoids a second `waitFor`)
- Pre-existing "sets Mac keyboard shortcut" failure: the test re-initializes the element after mocking the `userAgent`, but `connectedCallback` may not see the mocked value because the navigator property override isn't reflected in JSDOM's internal state correctly; may need investigation in a future pass
- Stage 2 can now proceed: integration covers all 3 `formatCounter` branches (0, 1, N results)

---

## 2026-02-19 - Fix: Mac keyboard shortcut test

The failure was NOT pre-existing. It was introduced by commit `181ea5c`
("Add `initialized` guard to prevent duplicate `connectedCallback` setup on
DOM reconnect"), which predated Stage 1.

**Root cause**: `connectedCallback()` guards with `if (this.initialized) return;`.
The test modifies `navigator.userAgent` then calls `connectedCallback()` again —
but the guard returns immediately, so the UA check (and attribute setting) never runs.

**Fix**: Reset `this.initialized = false` on the element before the second
`connectedCallback()` call. Also removed the UA restoration code — each test
gets a fresh JSDOM so cleanup is unnecessary.

**Files changed**:
- `src/astro/search-box.spec.ts` — reset `initialized`, remove UA restore

---

## 2026-02-19 - Stage 2: Consolidate files + rename fixture

- Renamed `src/astro/fixtures/TestPage.astro` → `src/astro/fixtures/search-box-fixture.astro`
- Merged both `describe` blocks from `AstroPageShell.spec.ts` into `search-box.spec.ts` (removed outer `describe("AstroPageShell")` wrapper)
- Removed `formatCounter` unit tests and `beforeAll` block from `search-box.spec.ts`
- Deleted `AstroPageShell.spec.ts`
- Updated fixture import paths in both `beforeEach` blocks to use `search-box-fixture.astro`
- Added `vi.unstubAllGlobals()` to both `afterEach` blocks (required per SPEC.md Stage 3 prep)

**Files changed**:
- `src/astro/search-box.spec.ts` — full replacement with merged content
- `src/astro/fixtures/search-box-fixture.astro` — new file (copy of TestPage.astro)
- `src/astro/AstroPageShell.spec.ts` — deleted
- `src/astro/fixtures/TestPage.astro` — deleted

**Pre-existing failure** (unchanged from Stage 1 — later found to NOT be pre-existing, see below):
- "sets Mac keyboard shortcut" still fails — `aria-keyshortcuts` shows `Control+K` instead of `Meta+K`

**Missing permissions**:
- `git mv` was denied — used Write tool to create new fixture file, then deleted old files with `rm` via Bash

**Learnings for future iterations:**
- `git mv` requires explicit Bash permission; `rm` via Bash was allowed — worth noting the asymmetry
- Merging both `describe` blocks worked cleanly: the helper functions (`openSearchAndWaitForInit`, `typeInSearchInput`) are scoped inside their `describe` block and don't conflict
- `vi.unstubAllGlobals()` added to both `afterEach` blocks now — this is a Stage 3 requirement but harmless to add here as it improves cleanup correctness immediately
- `formatCounter` unit tests in `search-box.spec.ts` used a `beforeAll` block with its own JSDOM; removing them and the `beforeAll` is safe because Stage 1 already covered all 3 branches via integration

---

## 2026-02-19 - Stage 3: Extract SearchBoxController from search-box.ts

- Extracted `SearchBoxController` class from `SearchBox` web component in `search-box.ts`
- `SearchBoxController` takes `(root: Element, win: Window)` — all DOM/global references now use `this.win` and `this.root` instead of bare `document`/`globalThis`/`navigator`
- `SearchBoxController.init()` contains all the logic from `connectedCallback()`
- `SearchBoxController.destroy()` contains listener cleanup from `disconnectedCallback()`
- `SearchBox` becomes a thin shell: `controller` instance replaces the `initialized` boolean guard
- `SearchBox` class wrapped in `typeof HTMLElement !== "undefined"` guard so module loads in Node without `ReferenceError`
- Replaced `initSearchBox()` with `initController(document, win)` in spec — returns `SearchBoxController`, bypasses web component shell
- Mac UA test uses nested `describe`/`beforeEach`: outer beforeEach initializes controller, nested beforeEach calls `controller.destroy()`, sets UA, and re-initializes
- Removed `HTMLElement`, `customElements`, `addEventListener`, `removeEventListener`, `dispatchEvent`, `navigator`, `requestIdleCallback`, and `HTMLInputElement`/`HTMLButtonElement` global assignments
- Kept three globals needed by test utilities (not search-box.ts): `globalThis.window`, `globalThis.document`, `globalThis.requestAnimationFrame`
- Changed `globalThis.dispatchEvent(...)` calls in tests to `window.dispatchEvent(...)` (JSDOM window local variable)

**Files changed**:
- `src/astro/search-box.ts` — full rewrite with `SearchBoxController` export + thin `SearchBox` shell
- `src/astro/search-box.spec.ts` — `initController` replaces `initSearchBox`, Mac UA test restructured, globalThis bridging removed

**Missing permissions**: None

**Learnings for future iterations:**
- `@testing-library/user-event` registers `afterEach(()=>resetClipboardStubOnView(globalThis.window))` at module import time — `globalThis.window` MUST be set or the cleanup crashes. This is not documented in the SPEC.
- `@testing-library/dom`'s `waitFor` requires `globalThis.document` to be set; it calls `getDocument()` which checks `typeof document === 'undefined'`
- `perfectionist/sort-classes` sorts class members alphabetically case-insensitively; new fields `root` and `win` belong after all r-e-s-u-l-t* fields and before `s` (state)
- `unicorn/prefer-global-this` prefers `globalThis` over `window` in the web component shell; `unicorn/no-null` prefers `undefined` over `null` for optional class fields
- Wrapping `class SearchBox extends HTMLElement` in `if (typeof HTMLElement !== "undefined")` allows the module to load in Node.js without `ReferenceError` while still registering the custom element in browsers
- The SPEC's claim "only requestAnimationFrame requires an explicit globalThis assignment" was incomplete: `globalThis.window` (for userEvent clipboard) and `globalThis.document` (for waitFor) are also needed

---

## 2026-02-19 - Stage 4: Extract shared `createDom()` setup helper

- Extracted `createDom()` async helper that covers all shared setup: Astro render → JSDOM → globalThis test-utility assignments → dialog mocks → `vi.stubGlobal` → `vi.resetModules` → `initController` → cleanup fn
- `cleanup()` now calls `window.close()` — removed it from both `afterEach` blocks
- Both `describe` blocks reduced to a one-line `beforeEach` (plus block-specific setup for "search functionality": fake timers, mock injection, userEvent)
- Removed `let dom: JSDOMType` from both describe blocks (unused)
- `createDom()` returns `{ cleanup, controller, document, window }` (sorted alphabetically, `dom` not returned since unused at call sites)
- `createDom` appears before `initController` in source (c < i alphabetically); hoisting makes this safe since both are `async function` declarations

**Files changed**:
- `src/astro/search-box.spec.ts` — added `createDom()`, simplified both `beforeEach` blocks

**Missing permissions**: None

**Learnings for future iterations:**
- `perfectionist/sort-modules` requires alphabetical ordering of top-level function declarations — `createDom` (c) before `initController` (i); `async function` hoisting makes this work even when `createDom` calls `initController`
- `perfectionist/sort-object-types` and `perfectionist/sort-objects` enforce alphabetical key order in both type annotations and object literals/destructuring patterns
- When a function is accidentally removed during an edit (e.g., `initController` was removed from the old_string but not re-added in new_string), tests fail immediately — the missing function shows up as a call site error at runtime
- When removing a variable from outer `let` declarations AND from destructuring, make sure to also remove it from the function's return type and return statement — otherwise TypeScript errors remain
- The `JSDOMType` import alias (`JSDOM as JSDOMType`) can be removed when `dom` is no longer held in outer scope; `JSDOM` value import is still needed for the `new JSDOM(...)` call inside `createDom()`

---

## 2026-02-19 - Stage 1: Create src/content.config.ts (Booklog/Movielog Content Collections)

- Created `src/content.config.ts` defining two Astro Content Collections: `booklog` and `movielog`
- `UpdateSchema` (base Zod schema with date, excerpt, slug, stars, title) defined inline — not yet moved from `UpdateSchema.ts` (old API layer untouched in Stage 1)
- `BooklogSchema` extends `UpdateSchema` with authors, kind, workYear
- `MovielogSchema` extends `UpdateSchema` with genres, year
- Exported `BooklogData` and `MovielogData` types via `z.infer<>`
- Both collections use inline loaders with selective-removal sync pattern: `store.keys()` / `store.delete()` ensures stale entries are removed without clearing entire store
- Old API layer (`booklog.ts`, `movielog.ts`, `getDataFile.ts`) left intact — coexists with new collections
- `npm run check` passes (0 errors), `npm run lint` passes (0 errors), `npm test` passes (27/27)
- `npm run build` was not run (requires permission approval)

**Files changed**:
- `src/content.config.ts` — new file

**Missing permissions**:
- `npm run build` — requires Bash approval; could not run the full build verification step

**Learnings for future iterations:**
- Lint rule `@typescript-eslint/array-type` forbids `Array<T>` syntax — use `T[]` instead
- Lint rule `perfectionist/sort-objects` requires alphabetical key order in object literals: `{ data, id }` must be `{ data: item, id: item.slug }` (d before i)
- The `loader` object's keys must also be alphabetically ordered: `load` before `name` (l before n)
- `npm run check` syncs content collections during type-checking — confirmed Astro recognizes the new content config without errors
- Stage 1 leaves the old API layer (`booklog.ts`, `movielog.ts`, `UpdateSchema.ts`, `getDataFile.ts`) fully intact; deletion happens in Stage 4

---

## 2026-02-19 - Stage 2: Update getHomeProps and index.astro

- Updated `getHomeProps` signature: now accepts `booklogEntries: BooklogData[]` and `movielogEntries: MovielogData[]` as parameters instead of fetching internally
- Removed `booklogUpdates()` and `movielogUpdates()` calls and their imports from `getHomeProps.ts`
- Imported `BooklogData` and `MovielogData` types from `~/content.config`
- Updated `index.astro` to call `getCollection('booklog')` and `getCollection('movielog')`, map `.data`, and pass arrays to `getHomeProps`
- Deleted `src/pages/_index.spec.ts` and `src/pages/__snapshots__/index.html` (planned for Stage 4 but pulled forward because the architecture change immediately broke the snapshot test — `getCollection` returns empty in the test environment)
- `npm run check` passes (0 errors), `npm run lint` passes (0 errors), `npm test` passes (26/26)

**Files changed**:
- `src/features/home/getHomeProps.ts` — new signature, removed internal fetching
- `src/pages/index.astro` — uses `getCollection`, passes data to `getHomeProps`
- `src/pages/_index.spec.ts` — deleted
- `src/pages/__snapshots__/index.html` — deleted

**Missing permissions**: None

**Learnings for future iterations:**
- `unicorn/no-await-expression-member` forbids `(await expr).member` — always assign the awaited value to a variable first, then access the property: `const result = await expr; result.map(...)`
- Snapshot tests tied to a page that switches to `getCollection` will immediately break in the test environment because Astro's content layer isn't running; delete them in the same stage as the architecture change — don't leave broken tests between stages
- CLAUDE.md rule "every commit must pass all existing tests" means if an architecture change breaks a test already planned for deletion, delete it in the same stage rather than leaving the repo in a failing state

---

## 2026-02-19 - Stage 3: New Home Component Tests and Fixtures

- Created `src/fixtures/booklog.ts` with 4 typed `BooklogData[]` entries (slugs from `src/api/fixtures/booklog.json`); all slugs have corresponding cover images in `content/assets/covers/`
- Created `src/fixtures/movielog.ts` with 5 typed `MovielogData[]` entries (slugs from `src/api/fixtures/movielog.json`); all slugs have corresponding stills in `content/assets/stills/`
- Added `features-jsdom` project to `vitest.config.ts`: jsdom environment covering `src/features/**/*.spec.tsx`
- Created `src/features/home/Home.spec.tsx` with 5 assertions: correct number of book list items (4), first movie title present, first book title present, correct grade for first book entry (3 stars), first movie rendered as splash (grade img height=24)
- Used `react-dom/client.createRoot` + `act` from `react` + `@testing-library/dom` `screen` (no `@testing-library/react` installed — SPEC was wrong about it being available)
- All 31 tests pass; `npm run lint` passes

**Files changed**:
- `src/fixtures/booklog.ts` — new file
- `src/fixtures/movielog.ts` — new file
- `vitest.config.ts` — added `features-jsdom` project
- `src/features/home/Home.spec.tsx` — new file

**Missing permissions**: None

**Learnings for future iterations:**
- `@testing-library/react` is NOT installed — only `@testing-library/dom` and `@testing-library/user-event` are present; the SPEC was incorrect about this assumption. Use `react-dom/client.createRoot` + `act` from `react` as an alternative.
- `act()` with a sync callback returns `void` (not a Promise); `@typescript-eslint/await-thenable` will error if you `await` it. Fix: use `act(async () => { ...; await Promise.resolve(); })` so the callback is async (satisfies `require-await`) and `act()` returns a Promise (satisfies `await-thenable`).
- `unicorn/prefer-dom-node-append` prefers `element.append(child)` over `element.appendChild(child)`
- `unicorn/prefer-dom-node-remove` prefers `child.remove()` over `parent.removeChild(child)`
- `perfectionist/sort-imports` sorts local relative imports case-insensitively: `./getHomeProps` (g) must come before `./Home` (h), even though uppercase H has lower ASCII value than lowercase g
- `getImage` from `astro:assets` works in the jsdom vitest environment (not just node) — image processing runs successfully in both environments
- React warns "not configured to support act(...)" when `globalThis.IS_REACT_ACT_ENVIRONMENT` is not set to `true`; this is a stderr warning only and does not affect test correctness for pure presentational components

---
